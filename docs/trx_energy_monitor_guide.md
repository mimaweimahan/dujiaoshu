# TRX能量租赁自动化监听程序 - 完整说明

## 📋 业务场景

这是一个 **TRX 能量自动租赁系统**，用于自动化处理能量租赁业务：

### 业务流程

```
用户想租用 TRON 能量
    ↓
用户转账 1.5 TRX 到您的监听地址
    ↓
程序检测到 1.5 TRX 到账
    ↓
程序查询配置: {"1.5": 32000}
    ↓
程序调用 start_energy_buy(32000, 用户地址)
    ↓
32000 能量自动转到用户地址
    ↓
完成！用户收到能量
```

---

## 🎯 核心逻辑说明

### **程序做什么？**

1. ⏱️ **每30秒检查一次** 您的 TRX 收款地址
2. 💰 **显示余额**：实时显示 TRX 和 USDT 余额
3. 🔍 **检测新到账**：发现有新的 TRX 转账
4. 🔎 **匹配套餐**：根据到账金额匹配能量数量
5. ⚡ **自动转能量**：调用 API 将能量转给付款人
6. 📝 **记录日志**：保存所有交易记录

### **配置示例**

在系统设置中配置 `energy_buy_config`：

```json
{
  "1.5": 32000,
  "3": 64000,
  "5": 100000
}
```

**含义**：
- 用户转 **1.5 TRX** → 系统自动转 **32,000 能量** 给用户
- 用户转 **3 TRX** → 系统自动转 **64,000 能量** 给用户  
- 用户转 **5 TRX** → 系统自动转 **100,000 能量** 给用户

---

## 📊 完整业务流程图

```
┌─────────────────────────────────────────────────┐
│  用户操作: 转账 1.5 TRX                         │
│  付款地址: TAbcdef... (用户的钱包地址)          │
│  收款地址: TXXXXxx... (您的监听地址)            │
└───────────────────┬─────────────────────────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │  区块链确认交易       │
        │  (约3秒)              │
        └───────────┬───────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │  程序每30秒检查一次   │◄────────┐
        └───────────┬───────────┘         │
                    │                     │
                    ▼                     │
        ┌───────────────────────┐         │
        │  调用 Tronscan API    │         │
        │  获取最新50笔交易     │         │
        └───────────┬───────────┘         │
                    │                     │
                    ▼                     │
        ┌───────────────────────┐         │
        │  发现新交易！         │         │
        │  - 金额: 1.5 TRX      │         │
        │  - 来自: TAbcdef...   │         │
        └───────────┬───────────┘         │
                    │                     │
                    ▼                     │
        ┌───────────────────────┐         │
        │  检查是否处理过？     │         │
        └───────────┬───────────┘         │
                    │                     │
              已处理？未处理               │
                    │                     │
                    ▼                     │
        ┌───────────────────────┐         │
        │  读取能量配置         │         │
        │  {"1.5":32000,...}    │         │
        └───────────┬───────────┘         │
                    │                     │
                    ▼                     │
        ┌───────────────────────┐         │
        │  匹配套餐             │         │
        │  1.5 TRX → 32000 能量 │         │
        └───────────┬───────────┘         │
                    │                     │
                    ▼                     │
        ┌───────────────────────┐         │
        │  调用能量购买API      │         │
        │  start_energy_buy(    │         │
        │    32000,             │         │
        │    "TAbcdef..."       │         │
        │  )                    │         │
        └───────────┬───────────┘         │
                    │                     │
                    ▼                     │
        ┌───────────────────────┐         │
        │  能量API处理          │         │
        │  - 购买能量           │         │
        │  - 转给用户           │         │
        └───────────┬───────────┘         │
                    │                     │
                    ▼                     │
        ┌───────────────────────┐         │
        │  用户收到32000能量    │         │
        └───────────┬───────────┘         │
                    │                     │
                    ▼                     │
        ┌───────────────────────┐         │
        │  标记交易已处理       │         │
        │  (写入缓存30天)       │         │
        └───────────┬───────────┘         │
                    │                     │
                    ▼                     │
        ┌───────────────────────┐         │
        │  记录成功日志         │         │
        └───────────┬───────────┘         │
                    │                     │
                    ▼                     │
        ┌───────────────────────┐         │
        │  等待30秒             │         │
        └───────────┬───────────┘         │
                    │                     │
                    └─────────────────────┘
                    (继续监听下一次)
```

---

## 🔧 核心方法详解

### **processBusinessLogic() - 能量转账核心**

**输入参数**：
- `$address` - 您的收款地址（配置中的 energy_address）
- `$amount` - 到账的 TRX 金额（如：1.5）
- `$txHash` - 交易哈希（区块链交易ID）
- `$fromAddress` - 付款人地址（**这是要接收能量的地址**）
- `$blockTimestamp` - 区块时间戳

**执行步骤**：

```php
// 步骤1: 记录交易到日志文件
logTransactionToFile(...);

// 步骤2: 获取能量配置
$config = dujiaoka_config_get("energy_buy_config");
// 返回: {"1.5":32000,"3":64000}

// 步骤3: 解析JSON配置
$rules = json_decode($config, true);
// 结果: ["1.5" => 32000, "3" => 64000]

// 步骤4: 匹配收到的TRX金额
if ($amount == 1.5) {
    $energyCount = 32000;
} else if ($amount == 3) {
    $energyCount = 64000;
}

// 步骤5: 调用能量购买函数
start_energy_buy($energyCount, $fromAddress);
// 参数1: 32000 (能量数量)
// 参数2: TAbcdef... (付款人地址，能量会转给他)
```

---

## 💡 关键理解

### **为什么要监听 TRX 到账？**

用户想租用能量 → 用户转 TRX 给您 → 您收到钱后转能量给用户

### **`start_energy_buy()` 函数做什么？**

这个函数已经在 `app/Helpers/functions.php` 中定义：
- 参数1: `$count` - 要购买的能量数量（如 32000）
- 参数2: `$address` - 要转给谁（付款人的地址）
- 功能: 调用第三方能量API，购买能量并转给指定地址

### **配置格式说明**

```json
{
  "TRX金额字符串": 能量数量整数
}
```

示例：
```json
{
  "1.5": 32000,    // 字符串 "1.5" 对应数字 32000
  "3": 64000,      // 字符串 "3" 对应数字 64000
  "5": 100000
}
```

---

## 📊 控制台输出示例（正确版本）

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 第 5 次监听检查 - 2025-01-01 12:02:00
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
💰 正在获取余额信息...
┌─────────────────────────────────────────┐
│  💎 TRX余额:            223.456789 TRX  │
│  💵 USDT余额:         1,234.567890 USDT │
└─────────────────────────────────────────┘

🔍 正在检查新交易...
📋 已获取到 50 条最近交易
⏰ 上次检查时间: 2025-01-01 12:01:30
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎉 发现 1 笔新交易！
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  💰 TRX到账通知                                   ┃
┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃  金额: 1.500000 TRX                               ┃
┃  哈希: abc123...def456                            ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

📝 开始处理业务逻辑...

📊 交易详情:
  ├─ 付款地址: TAbcdefgh...xyz123456
  ├─ 收款地址: TXXXXxxxx...XXXXxxxx
  ├─ 交易金额: 1.5 TRX
  ├─ 交易哈希: abc123...def456
  └─ 区块时间: 2025-01-01 12:01:45

⚙️ 执行能量转账业务逻辑...

  [1/3] 📄 记录交易日志...
        ✓ 日志记录成功
  [2/3] ⚡ 查询能量配置...
        ✓ 配置加载成功
  [3/3] 🔍 匹配能量数量...
        收到金额: 1.5 TRX
        ✓ 匹配成功: 1.5 TRX → 32,000 能量

  🚀 开始购买并转出能量...
     目标地址: TAbcdefgh...xyz123456
     能量数量: 32,000

     ✅ 能量转账成功！

✅ 业务逻辑处理完成

✅ 本次检查完成

⏳ 等待30秒后进行下一次检查...
```

---

## ⚙️ 必须配置的项

| 配置项 | 说明 | 示例值 |
|-------|------|--------|
| `tronscan_api` | Tronscan API密钥 | `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx` |
| `energy_address` | TRX收款地址 | `TXXXXxxxxXXXXxxxxXXXXxxxxXXXXxxxx` |
| `energy_buy_config` | 能量套餐配置 | `{"1.5":32000,"3":64000,"5":100000}` |
| `energy_api_token` | 能量API的Token | 在 start_energy_buy() 中使用 |
| `energy_api_secret` | 能量API的密钥 | 在 start_energy_buy() 中使用 |

---

## 🎯 关键代码逻辑

### **1. 监听到 TRX 到账**

```php
// 用户转了 1.5 TRX
$amount = 1.5;              // 到账金额
$fromAddress = "TAbcdef..."; // 付款人地址（这个地址要接收能量）
```

### **2. 读取能量配置**

```php
$config = dujiaoka_config_get("energy_buy_config");
// 返回: {"1.5":32000,"3":64000}

$rules = json_decode($config, true);
// 返回: ["1.5" => 32000, "3" => 64000]
```

### **3. 匹配能量数量**

```php
foreach ($rules as $requiredTrx => $energyAmount) {
    if ($amount == $requiredTrx) {  // 1.5 == "1.5"
        $energyCount = $energyAmount;  // 32000
        break;
    }
}

// 结果: $energyCount = 32000
```

### **4. 调用能量购买函数**

```php
start_energy_buy($energyCount, $fromAddress);
// 等同于:
start_energy_buy(32000, "TAbcdef...");

// 函数内部会:
// 1. 调用第三方能量API
// 2. 购买 32000 能量
// 3. 转给 TAbcdef... 这个地址
```

---

## 🚀 启动命令

```bash
# 前台运行（测试用）
php artisan listentrx

# 后台运行（生产用）
nohup php artisan listentrx > /dev/null 2>&1 &

# 或使用 screen
screen -S trx_monitor
php artisan listentrx
# 按 Ctrl+A 然后 D 退出

# 或使用 supervisor（推荐）
# 配置文件: /etc/supervisor/conf.d/trx_monitor.conf
[program:trx_monitor]
command=php /path/to/artisan listentrx
autostart=true
autorestart=true
```

---

## 📝 实际运行示例

### 场景1：收到匹配的金额

```
用户转账: 1.5 TRX
     ↓
程序检测到: 1.5 TRX
     ↓
配置匹配: {"1.5": 32000}
     ↓
调用函数: start_energy_buy(32000, "用户地址")
     ↓
结果: ✅ 32000能量已转给用户
```

**控制台输出**：
```
🔍 匹配能量数量...
    收到金额: 1.5 TRX
    ✓ 匹配成功: 1.5 TRX → 32,000 能量

🚀 开始购买并转出能量...
   目标地址: TAbcdefgh...xyz123456
   能量数量: 32,000
   
   ✅ 能量转账成功！
```

### 场景2：收到不匹配的金额

```
用户转账: 2 TRX （配置中没有这个金额）
     ↓
程序检测到: 2 TRX
     ↓
配置匹配: 未找到 "2"
     ↓
结果: ⚠️ 跳过处理，显示可用套餐
```

**控制台输出**：
```
🔍 匹配能量数量...
    收到金额: 2 TRX
    ⚠️ 未找到匹配的能量套餐
    可用套餐列表:
      - 1.5 TRX → 32,000 能量
      - 3 TRX → 64,000 能量
      - 5 TRX → 100,000 能量
```

### 场景3：重复处理防护

```
用户转账: 3 TRX
     ↓
第1次检查: 检测到并处理 ✅
     ↓
第2次检查: 检测到但已处理过 ⊗ 跳过
```

---

## 📁 日志文件

### 交易日志

**路径**：`storage/logs/trx_transactions_2025-01-01.log`

**格式**：每行一条JSON记录
```json
{
  "timestamp": "2025-01-01 12:00:00",
  "address": "TXXXXxxxx...",
  "amount": 1.5,
  "tx_hash": "abc123...",
  "from_address": "TAbcdef...",
  "to_address": "TXXXXxxxx...",
  "formatted_time": "2025-01-01 12:00:00"
}
```

### 能量转账日志

**路径**：`storage/logs/laravel.log`

**成功日志**：
```
[2025-01-01 12:00:01] local.INFO: TRX能量转账成功
{
  "tx_hash": "abc123...",
  "from_address": "TAbcdef...",
  "trx_amount": 1.5,
  "energy_count": 32000,
  "result": {...}
}
```

**失败日志**：
```
[2025-01-01 12:00:02] local.ERROR: TRX能量转账失败
{
  "tx_hash": "abc123...",
  "from_address": "TAbcdef...",
  "trx_amount": 2,
  "energy_count": null
}
```

---

## ⚠️ 重要注意事项

### ✅ 必须做的

1. **配置能量套餐**
   - 在系统设置中配置 `energy_buy_config`
   - 格式必须是标准 JSON：`{"1.5":32000,"3":64000}`
   - 金额可以是小数（如 1.5）

2. **启动监听程序**
   ```bash
   php artisan listentrx
   ```

3. **保持程序运行**
   - 使用 screen/tmux/supervisor 保持后台运行
   - 不要关闭终端

4. **定期检查日志**
   - 查看是否有转账失败
   - 确认能量是否成功转出

### ⚠️ 常见问题

**Q: 用户转了 2 TRX，但配置里没有怎么办？**

A: 程序会跳过处理，并在控制台显示可用套餐。用户的钱到账了，但不会转能量。

**Q: 同一笔交易会重复处理吗？**

A: 不会！程序会记录已处理的交易哈希（缓存30天），同一笔交易只处理一次。

**Q: start_energy_buy() 失败了怎么办？**

A: 会记录错误日志，但不会影响下次监听。建议定期检查日志。

**Q: 监听间隔可以改吗？**

A: 可以！修改 `sleep(30)` 的值，单位是秒。

---

## 🎯 总结

### 这个程序的核心逻辑是：

1. 🔄 **持续监听** TRX 地址（每30秒）
2. 💰 **显示余额** TRX 和 USDT 的实时余额
3. 🔍 **检测到账** 发现新的 TRX 转账
4. 🔎 **匹配套餐** 根据金额查找对应的能量数量
5. ⚡ **自动转能量** 调用 `start_energy_buy(能量数量, 用户地址)`
6. 📝 **记录日志** 所有操作都有日志记录

### 适用场景：

- ✅ TRX 能量自动租赁
- ✅ 无人值守自动化
- ✅ 7x24小时运行

---

**开发团队** | **版本：v2.0** | **业务：TRX能量租赁自动化**

